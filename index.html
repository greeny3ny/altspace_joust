<!DOCTYPE html>
<html>
	<body>
	
		<script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
		<script src="https://sdk.altvr.com/libs/altspace.js/2.8.1/altspace.min.js"></script>
		<script src="enemy.js"></script>
		<script src="physics.js"></script>
		<script>
		
			var joyPositions = []
			
			AFRAME.registerComponent('col',{
				schema:
				{
					jointCubeSize:{
						type: 'float',
						default: 40
					},
					b_id:{
						type: 'int'
					}
				},
				init: function(){
					const self = this;
					const object = self.el.object3D;
					
					object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
						joints: [['Index','Right',0],['Index', 'Left', 0]]	, jointCubeSize: self.data.jointCubeSize
					}));
					
					var boxID = self.data.b_id;
					
					object.addEventListener('jointcollisionenter', function(event){
					
						console.log("collide " + self.data.b_id);
					
						if (boxID == 0){
							console.log(event);
							jumpPress();
						}
						
						if (boxID == 1){
							console.log(event);
							joystickT = true;
							getHandPos();
						}
						
					});
					
					this.el.addEventListener('click', function(event){
						console.log("click");
						switch (boxID){
							case 0:
								jumpPress();
							break;
							case 10:
								joystickLeft();
								joyPositions[0] = true;
								joyPositions[1] = false;
								joyPositions[2] = false;
							break;
							case 11:
								joystickRight();
								joyPositions[0] = false;
								joyPositions[1] = false;
								joyPositions[2] = true;
							break;
							case 20:
								joystickCenter();
								joyPositions[0] = false;
								joyPositions[1] = true;
								joyPositions[2] = false;
							break;
						}
					});

					object.addEventListener('jointcollisionleave', function(event){
						console.log('leave!');
						if (boxID == 1){
							console.log("joystick let go!");
						}
					});
					
				}
			});
		
		function jumpPress(){
			document.querySelector('#button').emit('touch');
			document.querySelector('#button').emit('s');
			setTimeout(anim, 250);
			pJump();
		}
		
		function anim(){
			console.log("1 second passed");
			document.querySelector('#button').emit('left')
		}

		</script>
	
		<a-scene altspace="fullspace:false; verticalAlign: bottom" sync-system='app: Joust; author: Greeny3ny'>
			<!--<a-box position="0 1 0" n-skeleton-parent="part:head" scale='1 1 1'></a-box>-->
		
			<a-assets>
				<img id="display_temp" src="assets/joust.png" />
				<img id="buzzard_temp" src="assets/buzzard.png" />
			</a-assets>
		
			<!--a-entity id="left-controller" grip hand-controls="hand: left"></a-entity>-->
		
			<a-box color="yellow" position="0 0.4	0" scale="1 1.5 1"></a-box>
			<a-box color="blue" position="0 1.775	-0.25" scale="1 1.25 0.5"></a-box>
			<a-box id="display" src="#display_temp" position="0 1.8 0.005" scale="0.9 1.1 0.01"></a-box>
		
			<a-box id="button" position='0.2 1.15 0.3' col='b_id:0' scale="0.2 0.2 0.2" color='red' sync="ownOn:s" sync-transform>
				<a-animation attribute="position" begin="touch" from="0.2 1.15 0.3" to="0.2 1.1 0.3" dur="250"></a-animation>
				<a-animation attribute="position" begin="left" from="0.2 1.1 0.3" to="0.2 1.15 0.3" dur="250"></a-animation>
			</a-box>
			
			<a-box id="joystick" position='-0.2 1.15 0.3' col='b_id:1' rotation="0 0 0" scale='0.05 0.3 0.05' color="green" sync="ownOn:s" sync-transform>
				<a-sphere scale="0.7 0.1 0.7" position="0 0.5 0"></a-sphere>
				<a-animation attribute="rotation" begin="left" from="0 0 0" to="0 0 45" dur="250"></a-animation>
				<a-animation attribute="rotation" begin="right" from="0 0 0" to="0 0 -45" dur="250"></a-animation>
				
				<a-animation attribute="rotation" begin="cenFromLeft" from="0 0 45" to="0 0 0" dur="250"></a-animation>
				<a-animation attribute="rotation" begin="cenFromRight" from="0 0 -45" to="0 0 0" dur="250"></a-animation>
			</a-box>
			
			<a-box id="leftBox_temp" col='b_id:10' color="orange" scale="0.05 0.05 0.05" position ="-0.3 1.15 0.3"></a-box>
			<a-box id="rightBox_temp" col='b_id:11' color="orange" scale="0.05 0.05 0.05" position ="-0.1 1.15 0.3"></a-box>
			<a-box id="centerBox_temp" col='b_id:20' color="orange" scale="0.05 0.05 0.05" position ="-0.2 1.15 0.4"></a-box>
			
			<a-box id="player" src="#buzzard_temp" position='0 1.41 0.02' scale='0.075 0.075 0.075' sync="ownOn:s" sync-transform>
				<a-box id="lance" position='0 0 0.2' scale='2 0.1 0.1' color='orange'></a-box>
			</a-box>
			
		</a-scene>
	</body>
	<script>
		
		const scene = document.querySelector('a-scene');
		const SCALE = 0.075;
		
		const SIDEFORCE = 0.0008;
		
		//----
		
		var joystickT = false;
		var joyOr = "center";
		
		var playerX = 0;
		var playerY = 0; 

		var Y_Momentum = 0;
		var X_Momentum = 0;
		
		var skel;
		var l_hand;
		//---------
		console.log("loaded");
		
		altspace.getThreeJSTrackingSkeleton().then(function(event){
			skel = event;
			console.log("skeleton retrieved!");
		}).then(function(e){
			l_hand = skel.getJoint('Hand','Left');
			console.log(l_hand);
			console.log("hands retrieved!");
			console.log(l_hand.position);
		});
		
		var playerPhys = new physics();
		//called when jump pressed
		function pJump(){
			playerPhys.jump();
		}

		//called constantly
		function pFall(){
			playerY = playerPhys.posY();
		}//end fall

		//function constantly running, deals with xmovement of player
		function pXmove(){
			playerX = playerPhys.posX();
		}//end pmove
		
		function getHandPos(){
			l_hand = skel.getJoint('Hand','Left');
			//console.log(l_hand.position);
			
			var handPos = l_hand.position.x;
			var handZ = l_hand.position.z;
			
			console.log(handZ);
			if (handZ > 140){
				joyOr = "center";
				joystickT = false;
			}
			
			if (handPos < -10 && handPos > -45 && joystickT){
				joystickRight();
			}
			else if (handPos < -65 && handPos > -100 && joystickT){
				joyStickLeft();
			}
			else {
				joyStickCenter();
			}

		}//end gethandpos
		
		function joystickLeft(){
			document.querySelector('#joystick').setAttribute('rotation', "0 0 45");	
			X_Momentum -= SIDEFORCE;	
			if (joyOr != "left"){
				document.querySelector('#joystick').emit("left");
			}
			joyOr = "left";
		}
		
		function joystickRight(){
			document.querySelector('#joystick').setAttribute('rotation', "0 0 -45");
			X_Momentum += SIDEFORCE;
			if (joyOr != "right"){
				document.querySelector('#joystick').emit("right");
			}
			joyOr = "right";
		}
		
		function joystickCenter(){
			document.querySelector('#joystick').setAttribute('rotation', "0 0 0");
			if (joyOr == "right"){
				document.querySelector('#joystick').emit("cenFromRight");
			} else if (joyOr == "left"){
				document.querySelector('#joystick').emit("cenFromLeft");
			}
			joyOr = "center";	
		}
		
		//testing ---------------------
		var testEnemy = new enemy();
		
		function detectCollision(){
			
			var eX = testEnemy.eX();
			var eY = testEnemy.eY();
			const eZ = 0.02;
			
			if (playerX-0.0375 < (eX+0.0375) && playerX+0.0375 > (eX-0.0375)){
				//console.log("collision!");
				console.log(eY + " | " + playerY);
				if (playerY > eY){
					console.log("player win");
				}
				else if (eY > playerY){
					console.log("enemy win");
				}
				else {
					console.log("bump");
				}
				
				
			}
		}
		
		//-------------
		
		update();
		//this is the only function that repeats itself!!!
		function update(){
			//console.log("updating");
			document.querySelector('#player').setAttribute('position',  playerX + " " + playerY + " 0.02");
			document.querySelector('#player').emit("s");
			document.querySelector('#joystick').emit("s");
			
			pXmove();
			playerPhys.moveX();
			
			pFall();
			playerPhys.fall();
			
			detectCollision();
			
			if (joyPositions[0]){
				joystickLeft();
			} else if (joyPositions[1]){
				joystickCenter();
			} else if (joyPositions[2]){
				joystickRight();
			}
			
			if (joystickT){
				getHandPos();
			}
			
			window.requestAnimationFrame(update);
		}
		
		
	</script>
